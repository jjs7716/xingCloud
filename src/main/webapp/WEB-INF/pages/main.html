<html>
<head>
    <title>我的网盘</title>
    <script src="static/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css" />
    <script src="static/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script async="false" src="static/js/creatFile.js"></script>
    <script>
        function batchDownFile() {
            var checkId=document.getElementsByName("fileId");
            for(var i=0;i<checkId.length;i++){
                document.getElementById("key"+i).checked=document.getElementById("id"+i).checked
            }
            document.forms.namedItem("mainId").action="file/downloads";
            document.forms.namedItem("mainId").submit();
        }

        // function batchRecycleFile() {
        //     getList();
        //     var json={"control":"recycle","fileIdList":fileIdList,"folderIdList":folderIdList};
        //     $.ajax({
        //         url: pathUrl + "/recycle/controller",
        //         contentType: 'application/json; charset=UTF-8',
        //         dataType: "json",
        //         data:JSON.stringify(json),
        //         type: "post",
        //         success: function (result) {
        //             console.log("批量删除执行成功！");
        //                 main();
        //         }
        //     });
        // }

        $(document).ready(function() {
            // 根据网址激活导航条
            var url = window.location;
            $('ul.nav a[href="'+ url +'"]').parent().addClass('active');
            $('div.btn-group-vertical a[href="'+ url +'"]').parent().addClass('active');
            $('ul.nav a').filter(function() {
                return this.href == url;
            }).parent().addClass('active');
            $('div.btn-group-vertical a').filter(function() {
                return this.href == url;
            }).parent().addClass('active');

            $("#nickname").text();
        });
    </script>
    <style>
        #title{
            width: 100%;
            height: 10%;
            position:relative;
            font-size: 17px;
        }
        td,th{
            vertical-align: bottom;
        }
        #titleUser{
            position:relative;
            float: right;
            right: 20px;
        }
        #titleUl{
            position:relative;
            left: 11%;
            width: 89%;
            top: 50%;
        }
        #titleForm{
            position:relative;
            left: 30%;
           width: 30%;
        }
        #left{
            position:absolute;
            width: 9%;
        }
        #main{
            position: absolute;
            width: 89%;
            left: 10%;
            top: 10%;
        }
    </style>
</head>
<body>
<div id="title">
    <img src="/static/images/title.png" height="55%" width="50%" style="position:absolute; z-index:-1;top: 20%"/>
    <div id="titleUser"><img src="/static/images/background.jpeg" alt="38*38" class="img-circle" style="width: 38px;height: 38px">&nbsp;&nbsp;<p id="nickname"></p>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/file/transfer?transfer=setting">设置</a>&nbsp;&nbsp;<a href="/exit">退出</a></div>
    <ul class="nav nav-pills" id="titleUl">
        <li role="presentation"><a href="main">全部文件</a></li>
        <li role="presentation"><a href="file/search?type=video" id="video">视频</a></li>
        <li role="presentation"><a href="file/search?type=music" id="music">音乐</a></li>
        <li role="presentation"><a href="file/search?type=doc" id="doc">文档</a></li>
        <li role="presentation"><a href="file/search?type=img" id="img">图片</a></li>
    </ul>
    <form class="navbar-form " role="search" id="titleForm" action="file/search">
        <div class="form-group">
            <input type="text" class="form-control" name="search" id="search" value="" placeholder="搜索你的文件">
        </div>
        <button type="submit" class="btn btn-default" id="doSearch">查找</button>
    </form>
</div>
    <div id="left" class="btn-group-vertical btn-group-lg" role="group" aria-label="...">
        <button type="button" class="btn btn-default" onclick="location='transfer?transfer=main'">我的文件</button>
        <button type="button" class="btn btn-default" onclick="">我的好友</button>
        <button type="button" class="btn btn-default" onclick="">我的分享</button>
        <button type="button" class="btn btn-default" onclick="location='transfer?transfer=recycle'">回收站</button>
    </div>
<div id="main">
    <form id="mainId">
    <table class="table table-hover">
        <thead>
        <th width="3%"><input type="checkbox" id="checkAll" onclick="checkall()"></th>
        <th width="45%">文件名</th>
        <th width="10%">文件大小</th>
        <th width="20%">上传时间</th>
        <th >
            <input  class="btn btn-success" type="button" onclick='location="/file/transfer?transfer=main"' value="上传文件">
            <input class="btn btn-info" type="button" onclick="creatFolder()" value="新建文件夹">
            <input class="btn btn-primary" type="button" onclick="downFile()" value="批量下载">
            <input class="btn btn-danger" type="button"onclick="batch('recycle')" value="批量删除"></th>
        </thead>
        <tbody id="tbody">
        </tbody>
    </table>
    </form>
    </div>
</body>
<script>
    var pathArray = window.location.pathname.split('/');
    var secondLevelLocation = pathArray[1];
    var pathUrl = encodeURI(window.location.protocol+"//"+ window.location.host+"/"+secondLevelLocation);
    var username=$.cookie("cookieUsername");
    var userId=$.cookie("cookieUserId");

    $(document).ready(function () {
        $("#nickname").text(username);
        main();
    });

    //执行主方法
    function main() {
        $.ajax({
            url: pathUrl + "/file/main",
            contentType: 'application/json; charset=UTF-8',
            dataType: "json",
            type: "post",
            success: function (result) {
                if (result.status == true) {
                     folderList = result.data.folderList;
                    fileList = result.data.fileList;
                    creatMainList(folderList,fileList);
                } else {
                    $("#error").text(result.msg);
                }
            }
        });
    }

    //创建主页面文件夹列表
    function creatFolderList(folderList) {
        for(var i=0;i<folderList.length;i++) {
            var folder=folderList[i];
            $("#tbody").append("            <tr>\n" +
                "                <td>\n" +
                "                    <input type=\"checkbox\" id=\"folderId"+i+"\" name=\"folderId\" value=\""+folder.folderId+"\">\n" +
                // "                    <input type=\"checkbox\" id=\"key"+folder.folderId+"\" name=\"fileKey\" hidden>\n" +
                "                </td>\n" +
                "                <td id=\"name"+folder.folderId+"\"><a name='entryFolder'>"+folder.folderName+"</a></td>\n" +
                "                <td>-</td>\n" +
                "                <td>"+folder.updateTime+"</td>\n" +
                "                <td >\n" +
                "                    <input class=\"btn btn-success\" type=\"button\" onclick=\"downFolder("+i+")\" value=\"下载\">\n" +
                "                    <input class=\"btn btn-danger\" type=\"button\"  onclick=\"recycleFolder("+i+")\"  value=\"删除\">\n" +
                "                    <div class=\"btn-group\"><button type=\"button\" class=\"btn btn-primary dropdown-toggle\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">更多<span class=\"caret\"></span></button>\n" +
                "                        <ul class=\"dropdown-menu\">\n" +
                "                            <li><a href=\"#\" onclick=\"reName(&quot;"+folder.folderId+"&quot;,&quot;"+folder.isFolder+"&quot;)\" >重命名</a></li>\n" +
                "                            <li><a href=\"#\">移动</a></li>\n" +
                "                            <li><a href=\"#\">复制</a></li>\n" +
                "                            <li><a href=\"#\" onclick=\"recycleFolder("+i+")\">删除</a></li>\n" +
                "                        </ul>\n" +
                "                    </div>\n" +
                "            </tr>")
        }
    }

    //创建主页面文件列表
    function creatFileList(fileList) {
        for(var i=0;i<fileList.length;i++){
            var file=fileList[i];
            $("#tbody").append("        <tr>\n" +
                "            <td>\n" +
                "                <input type=\"checkbox\" id=\"fileId"+i+"\" name=\"fileId\" value=\""+file.fileId+"\">\n" +
                "                <input type=\"checkbox\" id=\"fileKey"+i+"\" name=\"fileKey\" value=\""+file.fileKey+"\" hidden>\n" +
                "            </td>\n" +
                "            <td id=\"name"+file.fileId+"\">"+file.fileName+"</td>\n" +
                "            <td>"+file.strFileSize+"</td>\n" +
                "            <td>"+file.updateTime+"</td>\n" +
                "            <td >\n" +
                "                <input class=\"btn btn-success\" type=\"button\" onclick=\"downFile("+i+")\" value=\"下载\">\n" +
                "                <input class=\"btn btn-danger\" type=\"button\" onclick=\"recycleFile("+i+")\" value=\"删除\">\n" +
                "                <div class=\"btn-group\"><button type=\"button\" class=\"btn btn-primary dropdown-toggle\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">更多<span class=\"caret\"></span></button>\n" +
                "                <ul class=\"dropdown-menu\">\n" +
                "                    <li><a href=\"#\" id=\"reName"+i+"\" onclick='reName(\""+file.fileId+"\",\""+file.isFolder+"\")'>重命名</a></li>\n" +
                "                    <li><a href=\"#\">移动</a></li>\n" +
                "                    <li><a href=\"#\">复制</a></li>\n" +
                "                    <li><a href=\"#\" onclick=\"recycleFile("+i+")\">删除</a></li>\n" +
                "                </ul>\n" +
                "                </div>\n" +
                "        </tr>")
        }
    }

    //创建主页面列表
    function creatMainList(folderList,fileList) {
        $("#tbody").empty();
        creatFolderList(folderList);
        creatFileList(fileList);
    }

    //下载文件夹
    function downFolder(folderId) {
        $.get(pathUrl+"/file/download?folderId"+folderId,
            function (result) {
                console.log(result)
            }
        )
    }

    //下载文件
    function downFile(fileId) {
        $.get(pathUrl+"/file/download?fileId="+fileId,
            function (result) {
                console.log(result)
            }
        )
    }

    //删除文件夹到回收站
    function recycleFolder(i) {
        $("#folderId"+i).closest("tr").attr("hidden","hidden");
        $("#folderId"+i).attr("checked","checked");
        batch("recycle");
    }

    //删除文件到回收站
    function recycleFile(i) {
        $("#fileId"+i).closest("tr").attr("hidden","hidden");
        $("#fileId"+i).attr("checked","checked");
        batch("recycle");
    }

    //重命名
    function reName(id,isFolder){
        let nameId="name"+id;
        let newId="newName"+id;
        let oldName=$("#"+nameId).text();
        $("#"+nameId).text("");
        $("#"+nameId).append("<div class=\"input-group\">\n" +
            "                    <input type=\"text\" class=\"form-control\" id="+newId+" value="+oldName+">\n" +
            "                    <span class=\"input-group-btn\">\n" +
            "                    <button class=\"btn btn-success\" onclick=\"confirmReName(&quot;"+id+"&quot;,&quot;"+isFolder+"&quot;)\" type=\"button\">确定</button>\n" +
            "                    <button class=\"btn btn-danger\" onclick=\"cancelReName(&quot;"+id+"&quot;,&quot;"+oldName+"&quot;)\" type=\"button\">取消</button>\n" +
            "                  </span>\n" +
            "                </div>");
    }

    //确认重命名
    function confirmReName(id,isFolder) {
        let fileId=$("#"+"id"+id).val();
        let nameId="name"+id;
        let newId="newName"+id;
        let newFileName=$("#"+newId).val();
        $.post(
            pathUrl+"/file/reFileName",
        {
            "isFolder":isFolder,
            "fileId":fileId,
            "newFileName":newFileName
        },
            function(data,status){
                console.log("Data: " + data + "\nStatus: " + status);
                $("#"+nameId).text(newFileName);
        })
    }

    // 取消重命名
    function cancelReName(id,oldName) {
        let nameId="name"+id;
        $("#"+nameId).text(oldName);
        $("#"+nameId).remove("div");
    }

    var label=0;
    // 新建文件夹
    function creatFolder() {
        // 标记，创建文件夹后是否点确认，没有则禁止继续创建
        if(label!=1){
            let folderId=md5(new Date().getMilliseconds());
        console.log(folderId);
        $("#tbody").prepend("        <tr id=\"tr"+folderId+"\">\n" +
            "            <td>\n" +
            "                <input type=\"checkbox\"  value="+folderId+" hidden>\n" +
            "            </td>\n" +
            "            <td id=\"folderName"+folderId+"\"><a name='entryFolder'></a></td>\n" +
            "            <td></td>\n" +
            "            <td></td>\n" +
            "            <td >\n" +
            "                <input class=\"btn btn-success\" type=\"button\" onclick=\"downFolder(&quot;"+folder.folderId+"&quot;)\" value=\"下载\">\n" +
            "                <input class=\"btn btn-danger\" type=\"button\" onclick=\"deleteFolder(&quot;"+folder.folderId+"&quot;)\" value=\"删除\">\n" +
            "                <div class=\"btn-group\"><button type=\"button\" class=\"btn btn-primary dropdown-toggle\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">更多<span class=\"caret\"></span></button>\n" +
            "                <ul class=\"dropdown-menu\">\n" +
            "                    <li><a href=\"#\" id=\"reFolderName"+folderId+"\" onclick=\"reFolderName(&quot;"+folderId+"&quot;)\" >重命名</a></li>\n" +
            "                    <li><a href=\"#\">移动</a></li>\n" +
            "                    <li><a href=\"#\">复制</a></li>\n" +
            "                </ul>\n" +
            "                </div>\n" +
            "        </tr>");
        var oldName="新建文件夹";
        $("#"+"folderName"+folderId).append("<div class=\"input-group\">\n" +
            "                    <input type=\"text\" class=\"form-control\" id="+folderId+" value="+oldName+">\n" +
            "                    <span class=\"input-group-btn\">\n" +
            "                    <button class=\"btn btn-success\" onclick=\"confirmFolderName(&quot;"+folderId+"&quot;)\" type=\"button\">确定</button>\n" +
            "                    <button class=\"btn btn-danger\" onclick=\"cancelFolderName(&quot;"+folderId+"&quot;)\" type=\"button\">取消</button>\n" +
            "                  </span>\n" +
            "                </div>");
            label=1;
        }
    }

    //确认创建文件夹
    function confirmFolderName(folderId) {
        var folderName=$("#"+folderId).val();
        $("#folderName"+folderId).children("div").remove();
        $("#folderName"+folderId).children("a").text(folderName);
        $.post(pathUrl+"/folder/creatFolder",
            {
                "folderId":folderId,
                "folderName":folderName
            },
            function(data,status){
                // console.log("Data: " + data + "\nStatus: " + status);
                label=0;
            });
    }
    //取消创建文件夹
    function cancelFolderName(folderId) {
        var nameId="tr"+folderId;
        console.log(nameId);
        $("#"+nameId).remove();
        label=0;
    }
    //进入文件夹
    function folder(folderId) {
        console.log("folder执行了！");
        $.ajax({
            url:pathUrl+"/folder/folder",
            data:folderId,
            type:"get",
            success:function(result){
                if(result.status==true){
                    creatMainList(result.data.folderList,result.data.fileList);
                }else{
                    $("#error").text(result.msg);
                }
            }
        });
    }
</script>
</html>
